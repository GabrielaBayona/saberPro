<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">

<head th:replace="layout/admin-layout :: head('Configuraci√≥n')"></head>

<body>

<div class="container-fluid">
    <div class="row">

        <!-- SIDEBAR -->
        <div th:replace="layout/admin-layout :: sidebar"></div>

        <!-- CONTENIDO PRINCIPAL -->
        <div class="col-md-10 p-4">
            
            <!-- HEADER -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3 class="mb-0">‚öôÔ∏è Configuraci√≥n del Sistema</h3>
                <a th:href="@{/admin/dashboard}" class="btn btn-secondary">
                    ‚¨ÖÔ∏è Volver
                </a>
            </div>

            <!-- MENSAJES -->
            <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
                ‚úÖ <span th:text="${success}"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>

            <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
                ‚ùå <span th:text="${error}"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>

            <div class="row g-4">

                <!-- MI PERFIL -->
                <div class="col-md-6">
                    <div class="card shadow-lg">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">üë§ Mi Perfil</h5>
                        </div>
                        <div class="card-body">
                            <div class="text-center mb-4">
                                <div class="avatar-large bg-primary text-white rounded-circle d-inline-flex align-items-center justify-content-center"
                                     style="width: 100px; height: 100px; font-size: 3rem; font-weight: bold;">
                                    <span th:text="${#strings.substring(usuario.correo, 0, 1).toUpperCase()}">A</span>
                                </div>
                            </div>

                            <form th:action="@{/admin/configuracion/actualizar-perfil}" method="post">
                                <div class="mb-3">
                                    <label class="form-label"><strong>Correo Electr√≥nico</strong></label>
                                    <input type="email" 
                                           class="form-control" 
                                           name="correo"
                                           th:value="${usuario.correo}"
                                           required>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label"><strong>Rol</strong></label>
                                    <input type="text" 
                                           class="form-control" 
                                           th:value="${usuario.rol}"
                                           disabled>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label"><strong>ID de Usuario</strong></label>
                                    <input type="text" 
                                           class="form-control" 
                                           th:value="${usuario.id}"
                                           disabled>
                                </div>

                                <button type="submit" class="btn btn-primary w-100">
                                    üíæ Guardar Cambios
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- CAMBIAR MI CONTRASE√ëA -->
                <div class="col-md-6">
                    <div class="card shadow-lg">
                        <div class="card-header bg-warning text-dark">
                            <h5 class="mb-0">üîí Cambiar mi Contrase√±a</h5>
                        </div>
                        <div class="card-body">
                            <form th:action="@{/admin/configuracion/cambiar-password}" method="post" id="formCambiarPassword">
                                
                                <div class="mb-3">
                                    <label class="form-label"><strong>Contrase√±a Actual</strong></label>
                                    <input type="password" 
                                           class="form-control" 
                                           name="passwordActual"
                                           placeholder="Ingrese su contrase√±a actual"
                                           required>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label"><strong>Nueva Contrase√±a</strong></label>
                                    <input type="password" 
                                           class="form-control" 
                                           name="passwordNueva"
                                           id="passwordNueva"
                                           placeholder="M√≠nimo 6 caracteres"
                                           minlength="6"
                                           required>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label"><strong>Confirmar Nueva Contrase√±a</strong></label>
                                    <input type="password" 
                                           class="form-control" 
                                           name="passwordConfirmar"
                                           id="passwordConfirmar"
                                           placeholder="Repita la nueva contrase√±a"
                                           minlength="6"
                                           required>
                                    <small id="passwordError" class="text-danger" style="display:none;">
                                        Las contrase√±as no coinciden
                                    </small>
                                </div>

                                <button type="submit" class="btn btn-warning w-100 text-dark">
                                    üîê Cambiar Contrase√±a
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

            </div>

            <!-- GESTIONAR CONTRASE√ëAS DE USUARIOS -->
            <div class="card shadow-lg mt-4">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0">üîë Gestionar Contrase√±as de Usuarios</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-warning">
                        <strong>‚ö†Ô∏è Atenci√≥n:</strong> Solo use esta funci√≥n cuando un usuario haya olvidado su contrase√±a. 
                        La nueva contrase√±a debe ser comunicada de forma segura al usuario.
                    </div>

                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>#</th>
                                    <th>Correo</th>
                                    <th>Rol</th>
                                    <th class="text-center">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="user, iter : ${todosUsuarios}">
                                    <td th:text="${iter.count}">1</td>
                                    <td>
                                        <strong th:text="${user.correo}">usuario@uts.edu.co</strong>
                                        <span class="badge bg-info ms-2" th:if="${user.id == usuario.id}">T√∫</span>
                                    </td>
                                    <td>
                                        <span class="badge" 
                                              th:classappend="${user.rol == 'ADMIN'} ? 'bg-danger' : 'bg-primary'"
                                              th:text="${user.rol}">ADMIN</span>
                                    </td>
                                    <td class="text-center">
                                        <button type="button" 
                                                class="btn btn-sm btn-warning"
                                                th:attr="data-user-id=${user.id}, data-user-email=${user.correo}"
                                                onclick="mostrarModalRestablecer(this)">
                                            üîë Restablecer Contrase√±a
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- INFORMACI√ìN DEL SISTEMA -->
            <div class="card shadow-lg mt-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">‚ÑπÔ∏è Informaci√≥n del Sistema</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>üè¢ Instituci√≥n:</strong> UTS - Unidades Tecnol√≥gicas de Santander</p>
                            <p><strong>üìä Sistema:</strong> Gestor Saber Pro & TyT</p>
                            <p><strong>üìÖ Versi√≥n:</strong> 1.0.0 (2025)</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>üíæ Base de Datos:</strong> H2 (En memoria)</p>
                            <p><strong>üîê Autenticaci√≥n:</strong> Sesi√≥n HTTP</p>
                            <p><strong>üë• Total Usuarios:</strong> <span th:text="${todosUsuarios.size()}">0</span></p>
                        </div>
                    </div>
                </div>
            </div>

        </div>

    </div>
</div>

<!-- Modal Restablecer Contrase√±a -->
<div class="modal fade" id="modalRestablecer" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title">üîë Restablecer Contrase√±a</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form th:action="@{/admin/configuracion/restablecer-password-usuario}" method="post">
                <div class="modal-body">
                    <input type="hidden" name="usuarioId" id="usuarioIdRestablecer">
                    
                    <div class="alert alert-warning">
                        <strong>Usuario:</strong> <span id="usuarioEmailRestablecer"></span>
                    </div>

                    <div class="mb-3">
                        <label class="form-label"><strong>Nueva Contrase√±a</strong></label>
                        <input type="text" 
                               class="form-control" 
                               name="nuevaPassword"
                               placeholder="Ingrese la nueva contrase√±a"
                               minlength="6"
                               required>
                        <small class="text-muted">M√≠nimo 6 caracteres. Comunique esta contrase√±a al usuario de forma segura.</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-warning">üîê Restablecer Contrase√±a</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // Validar que las contrase√±as coincidan
    document.getElementById('formCambiarPassword').addEventListener('submit', function(e) {
        const password = document.getElementById('passwordNueva').value;
        const confirmar = document.getElementById('passwordConfirmar').value;
        const error = document.getElementById('passwordError');
        
        if (password !== confirmar) {
            e.preventDefault();
            error.style.display = 'block';
            document.getElementById('passwordConfirmar').classList.add('is-invalid');
        } else {
            error.style.display = 'none';
            document.getElementById('passwordConfirmar').classList.remove('is-invalid');
        }
    });

    // Mostrar modal para restablecer contrase√±a
    function mostrarModalRestablecer(button) {
        const userId = button.getAttribute('data-user-id');
        const userEmail = button.getAttribute('data-user-email');
        
        document.getElementById('usuarioIdRestablecer').value = userId;
        document.getElementById('usuarioEmailRestablecer').textContent = userEmail;
        
        const modal = new bootstrap.Modal(document.getElementById('modalRestablecer'));
        modal.show();
    }
</script>

</body>
</html>